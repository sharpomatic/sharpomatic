<div #designerSurface class="designer-surface" 
  [class.panning]="isPanDragging()"
  (mousedown)="onSurfaceMouseDown($event)"
  (mousemove)="onSurfaceMove($event)" 
  (mouseup)="onSurfaceMouseUp($event)"
  (wheel)="onSurfaceWheel($event)"
  (mouseleave)="onSurfaceLeave()"
  (contextmenu)="onSurfaceContextMenu($event)">
  @if (selectionRect(); as rect) {
  <div class="selection-rect" 
    [style.left.px]="rect.left" 
    [style.top.px]="rect.top" 
    [style.width.px]="rect.width"
    [style.height.px]="rect.height"></div>
  }

  <div class="designer-content" [style.transform]="getPanTransform()">
    <div class="designer-zoom" [style.transform]="getZoomTransform()">
      <svg class="connector-surface">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#DEE2E6" />
        </marker>
        <marker id="arrowhead-selected" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#3184FD" />
        </marker>
      </defs>
      @for (connection of workflow().connections(); track connection.id) {
      <g class="connection-wrapper" (mousedown)="onConnectionMouseDown(connection, $event)">
        <path class="connection-path-hit-area" [attr.d]="getConnectionCurve(connection)"></path>
        <path class="connector-path" 
          [attr.d]="getConnectionCurve(connection)"
          [attr.marker-end]="selectedEntities().includes(connection) ? 'url(#arrowhead-selected)' : 'url(#arrowhead)'"
          [class.selected]="selectedEntities().includes(connection)"></path>
      </g>
      }
      @if (pendingConnection(); as pending) {
        <path class="connector-path pending" [attr.d]="getConnectionCurve(pending)" marker-end="url(#arrowhead)"></path>
      }
      </svg>

      @for (node of workflow().nodes(); track node.id) {
      <div class="node" 
        (mousedown)="onNodeMouseDown(node, $event)" 
        (mouseup)="onNodeMouseUp(node, $event)"
        (dblclick)="onNodeDoubleClick(node)" 
        [class.running]="!selectedEntities().includes(node) && node.displayState() === NodeStatus.Running"
        [class.success]="!selectedEntities().includes(node) && node.displayState() === NodeStatus.Success"
        [class.failed]="!selectedEntities().includes(node) && node.displayState() === NodeStatus.Failed" 
        [class.selected]="selectedEntities().includes(node)"
        [style.width.px]="node.width()"
        [style.height.px]="node.height()" 
        [style.transform]="'translate(' + node.left() + 'px, ' + node.top() + 'px)'">
        <div class="node-title">{{ node.title() }}</div>
        <div class="node-title">{{ node.title() }}</div>
        @if (getNodeSymbol(node.nodeType()); as symbol) {
        <i class="node-symbol bi" [class]="symbol"></i>
        }
        @for (connector of node.inputs(); track connector.id) {
        <div class="connector input" 
          (mousedown)="onInputMouseDown(connector, $event)"
          (mouseup)="onInputMouseUp(connector, $event)" 
          [style.width.px]="16" [style.height.px]="16"
          [style.transform]="'translate(-50%, ' + connector.boxOffset() + 'px)'"></div>
        @if (connector.name()) {
        <span class="connector-label input"
          [style.transform]="'translate(-' + connector.labelOffsetH() + 'px, ' + connector.labelOffsetV() + 'px)'">{{
          connector.name() }}</span>
        }
        }
        @for (connector of node.outputs(); track connector.id) {
        <div class="connector output" 
          (mousedown)="onOutputMouseDown(connector, $event)"
          (mouseup)="onOutputMouseUp(connector, $event)" 
          [style.width.px]="16" 
          [style.height.px]="16"
          [style.transform]="'translate(50%, ' + connector.boxOffset() + 'px)'"></div>
          @if (connector.name()) {
          <span class="connector-label output"
            [style.transform]="'translate(' + connector.labelOffsetH() + 'px, ' + connector.labelOffsetV() + 'px)'">{{
            connector.name() }}</span>
          }
        }
    </div>
      }
    </div>
  </div>
</div>
