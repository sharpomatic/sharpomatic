<div class="d-flex flex-column dialog-overlay bg-body-secondary">
  <div class="d-flex flex-column dialog-content">
    <div class="d-flex justify-content-between align-items-center p-3 pt-2 pb-1">
      <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0"><i class="bi bi-activity pe-3 icon-sm"></i>Run Viewer</h2>
      </div>
      <button class="btn btn-primary" (click)="onClose()">Close</button>
    </div>

    <div class="tab-shell">
      <app-tab [tabs]="tabs" [(activeTabId)]="activeTabId"></app-tab>
    </div>

    <ng-template #runTab>
      <div class="bg-body-tertiary p-3 run-details">
        <table class="table table-sm table-striped mb-0">
          <tbody>
            @for (property of runProperties; track property.label) {
            <tr>
              <th scope="row" class="run-property-label">{{ property.label }}</th>
              <td class="run-property-value">{{ property.value }}</td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </ng-template>

    <ng-template #inputTab>
      <div class="bg-body-tertiary flex-grow-1 d-flex flex-column p-3 h-100">
        @if (runInputs.entries().length > 0) {
        <div class="run-inputs flex-grow-1">
          <div class="d-flex align-items-start gap-2 mb-2">
            <label class="form-label editPath mb-0">Path</label>
            <label class="form-label editType mb-0">Type</label>
            <label class="form-label editValue mb-0">Value</label>
          </div>
          @for (entry of runInputs.entries(); track entry.id) {
          <div class="d-flex align-items-start gap-2 mb-2 run-input-row">
            <input type="text" class="form-control editPath" [value]="entry.inputPath()" readonly />
            <input type="text" class="form-control editType" [value]="getEntryTypeDisplay(entry.entryType())" readonly />
            @if (entry.entryType() === contextEntryType.JSON) {
            <div class="editValue">
              <ngx-monaco-editor class="editJson" [options]="getEditorOptions(entry)" [ngModel]="entry.entryValue()" />
            </div>
            } @else if (entry.entryType() === contextEntryType.Expression) {
            <div class="editValue">
              <ngx-monaco-editor class="editExpression" [options]="getEditorOptions(entry)" [ngModel]="entry.entryValue()" />
            </div>
            } @else if (entry.entryType() === contextEntryType.Bool) {
            <div class="d-flex editValue">
              <select class="form-select editBoolValue" [ngModel]="entry.entryValue() || 'False'" disabled>
                <option value="True">True</option>
                <option value="False">False</option>
              </select>
            </div>
            } @else if (entry.entryType() === contextEntryType.Int) {
            <input type="number" class="form-control editValue" inputmode="numeric" pattern="[0-9]*" step="1"
              [ngModel]="entry.entryValue() !== '' ? +entry.entryValue() : null" readonly />
            } @else if (entry.entryType() === contextEntryType.Double) {
            <input type="number" class="form-control editValue" inputmode="decimal" step="any"
              [ngModel]="entry.entryValue() !== '' ? +entry.entryValue() : null" readonly />
            } @else {
            <input type="text" class="form-control editValue" [ngModel]="entry.entryValue()" readonly />
            }
          </div>
          }
        </div>
        } @else {
        <div class="text-muted fst-italic input-empty-state">(empty)</div>
        }
      </div>
    </ng-template>

    <ng-template #outputTab>
      <div class="bg-body-tertiary flex-grow-1 d-flex flex-column p-3 h-100">
        <app-context-viewer [contexts]="outputContexts" mode="simple"></app-context-viewer>
      </div>
    </ng-template>

    <ng-template #traceTab>
      <div class="bg-body-tertiary flex-grow-1 p-1 h-100">
        @if (isLoadingTraces) {
        <div class="text-muted fst-italic p-2">Loading trace data...</div>
        } @else if (traces.length === 0) {
        <div class="text-muted fst-italic p-2">No trace data.</div>
        } @else {
        @for (trace of traces; track trace.traceId) {
        <div class="d-flex flex-row trace-line flex-grow-1">
          <i class="bi trace-symbol flex-shrink-0" [class]="getNodeSymbol(trace.nodeType)"></i>
          <div class="trace-title flex-shrink-0">{{ trace.title }}</div>
          <div class="d-flex flex-column trace-message flex-grow-1 align-items-start">
            <span class="trace-text" [class.running]="trace.nodeStatus === NodeStatus.Running"
              [class.success]="trace.nodeStatus === NodeStatus.Success"
              [class.failed]="trace.nodeStatus === NodeStatus.Failed">
              {{ trace.message || '' }}
            </span>
            @if (trace.nodeStatus === NodeStatus.Failed) {
            <span>{{ trace.error }}</span>
            }
          </div>
        </div>
        }
        }
      </div>
    </ng-template>
  </div>
</div>
